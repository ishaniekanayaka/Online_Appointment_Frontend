<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Category Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated Bubbles Background */
        .bubbles {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            overflow: hidden;
        }

        .bubble {
            position: absolute;
            bottom: -100px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            animation: rise 15s infinite ease-in;
        }

        .bubble:nth-child(1) {
            width: 40px;
            height: 40px;
            left: 10%;
            animation-duration: 8s;
        }

        .bubble:nth-child(2) {
            width: 20px;
            height: 20px;
            left: 20%;
            animation-duration: 5s;
            animation-delay: 1s;
        }

        .bubble:nth-child(3) {
            width: 50px;
            height: 50px;
            left: 35%;
            animation-duration: 7s;
            animation-delay: 2s;
        }

        .bubble:nth-child(4) {
            width: 80px;
            height: 80px;
            left: 50%;
            animation-duration: 11s;
            animation-delay: 0s;
        }

        .bubble:nth-child(5) {
            width: 35px;
            height: 35px;
            left: 55%;
            animation-duration: 6s;
            animation-delay: 1s;
        }

        .bubble:nth-child(6) {
            width: 45px;
            height: 45px;
            left: 65%;
            animation-duration: 8s;
            animation-delay: 3s;
        }

        .bubble:nth-child(7) {
            width: 25px;
            height: 25px;
            left: 75%;
            animation-duration: 7s;
            animation-delay: 2s;
        }

        .bubble:nth-child(8) {
            width: 80px;
            height: 80px;
            left: 80%;
            animation-duration: 6s;
            animation-delay: 1s;
        }

        @keyframes rise {
            0% {
                bottom: -100px;
                transform: translateX(0);
            }
            50% {
                transform: translateX(100px);
            }
            100% {
                bottom: 1080px;
                transform: translateX(-200px);
            }
        }

        /* Navbar Styles */
        #category-nav {
            background: rgba(193, 116, 157, 0.98);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .navbar-brand {
            font-weight: 700;
            color: white !important;
            font-size: 1.5rem;
        }

        .navbar-brand i {
            margin-right: 10px;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            font-weight: 500;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            color: white !important;
            transform: translateY(-2px);
        }

        /* Card Styles */
        .category-card, .gig-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .category-card:hover, .gig-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .category-card img, .gig-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .category-card:hover img, .gig-card:hover .gig-image {
            transform: scale(1.05);
        }

        .category-card h3, .gig-card h3 {
            padding: 15px;
            margin: 0;
            color: #8a1445;
        }

        .category-card p, .gig-card p {
            padding: 0 15px 15px;
            color: #666;
        }

        /* Gigs Specific Styles */
        .gig-card-header {
            position: relative;
            overflow: hidden;
        }

        .gig-rating {
            padding: 0 15px 15px;
            color: #ffc107;
        }

        .gig-card-body p {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 2px;
            margin-top: -10px;
        }

        .gig-card-body i {
            color: #4361ee;
            width: 10px;
            text-align: center;
        }

        .gig-card-footer {
            padding: 5px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
        }

        .book-appointment {
            background: #8a1445;
            border: none;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .book-appointment:hover {
            background: #3a56d4;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        /* Loader Styles */
        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            gap: 15px;
        }

        .loader-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4361ee;
            animation: bounce 1s infinite ease-in-out;
        }

        .loader-circle:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loader-circle:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        /* Empty State Styles */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .empty-state i {
            font-size: 50px;
            color: #4361ee;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #4361ee;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #666;
            font-size: 1.1rem;
        }

        /* Image Modal Styles */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            overflow: auto;
            justify-content: center;
            align-items: center;
        }

        .image-modal.show {
            display: flex;
        }

        .modal-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            color: #4361ee;
            transform: rotate(90deg);
        }

        /* Back Button */
        .back-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #4361ee;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            box-shadow: 0 5px 20px rgba(67, 97, 238, 0.3);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }

        .back-button.show {
            opacity: 1;
            visibility: visible;
        }

        .back-button:hover {
            background: #3a56d4;
            transform: translateY(-5px);
        }
        .notification-dropdown {
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            padding: 0;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            margin-top: 0.5rem;
        }
        
        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #f1f1f1;
            font-weight: 600;
            color: #1e293b;
            background-color: #ffffff;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f1f1f1;
            transition: all 0.3s ease;
        }
        
        .notification-item:hover {
            background-color: #f1f5f9;
            transform: translateY(-2px);
        }
        
        .notification-empty {
            padding: 2rem 1rem;
            text-align: center;
            color: #64748b;
        }
        
        .notification-gig {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #1e293b;
        }
        
        .notification-time {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }
        
        .notification-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .notification-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .cancel-btn {
            background-color: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cancel-btn:hover {
            background-color: #fecaca;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .status-accepted {
            background-color: #d1fae5;
            color: #059669;
        }
        
        .status-rejected {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.7rem;
            padding: 3px 6px;
            border-radius: 50%;
            background-color: #ef4444;
            color: white;
        }

        /* Chat Bot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(20px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .chatbot-container.open {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .chatbot-header {
            background: #4361ee;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-header h5 {
            margin: 0;
            font-weight: 600;
        }

        .chatbot-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chatbot-close-btn:hover {
            transform: rotate(90deg);
        }

        .chatbot-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .bot-message {
            background: #f1f1f1;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .user-message {
            background: #4361ee;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .chatbot-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        .chatbot-input input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 50px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chatbot-input input:focus {
            border-color: #4361ee;
        }

        .chatbot-input button {
            background: #4361ee;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chatbot-input button:hover {
            background: #3a56d4;
            transform: translateY(-2px);
        }

        .chatbot-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #4361ee;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(67, 97, 238, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .chatbot-toggle:hover {
            background: #3a56d4;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.4);
        }

        /* Toast Styles */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 4px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 9999;
        }
        .toast.show {
            opacity: 1;
        }
        .toast-info {
            background-color: #4361ee;
        }
        .toast-success {
            background-color: #4CAF50;
        }
        .toast-error {
            background-color: #F44336;
        }

        .like-button {
    margin-right: 10px;
    transition: all 0.3s;
}

.like-button:hover {
    transform: scale(1.05);
}

.like-button.liked {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #212529;
}

.like-button.liked i {
    color: #ffc107;
}

.star-count {
    font-weight: bold;
    color: #ffc107;
}
    </style>
</head>
<body>
<!-- Animated Background Bubbles -->
<div class="bubbles">
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
</div>

<!-- Stunning Floating Navbar -->
<nav id="category-nav" class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="fas fa-boxes"></i>MeetUpPro
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
            <i class="fas fa-bars text-white"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarContent">
            <ul id="category-list" class="navbar-nav ms-auto"></ul>
             <!-- Notification Dropdown -->
             <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="notificationDropdown" role="button" 
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end notification-dropdown" 
                        aria-labelledby="notificationDropdown" id="notificationList">
                        <li class="dropdown-header notification-header">Your Appointments</li>
                        <li class="notification-empty">No appointments found</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Main Content -->
<div class="container-fluid mt-4">
    <!-- Loading Indicator -->
    <div class="loader d-none" id="loader">
        <div class="loader-circle"></div>
        <div class="loader-circle"></div>
        <div class="loader-circle"></div>
    </div>

    <!-- Subcategories Container -->
    <div id="subcategory-container" class="row g-4 px-3"></div>

    <!-- Gigs Container -->
    <div id="gigs-container" class="row g-4 px-3 d-none"></div>
</div>

<!-- Back Button -->
<div id="back-button" class="back-button">
    <i class="fas fa-arrow-left"></i>
</div>

<!-- Image Modal -->
<div class="image-modal" id="imageModal">
    <span class="close-modal">&times;</span>
    <img class="modal-image" id="modalImage" src="" alt="Enlarged view">
</div>

<!-- Chat Bot Toggle Button -->
<div class="chatbot-toggle" id="chatbotToggle">
    <i class="fas fa-comments"></i>
</div>

<!-- Chat Bot Container -->
<div class="chatbot-container" id="chatbotContainer">
    <div class="chatbot-header">
        <h5>Appointment Assistant</h5>
        <button class="chatbot-close-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="chatbot-messages" id="chatbotMessages"></div>
    <div class="chatbot-input">
        <input type="text" id="chatbotInput" placeholder="Type your message...">
        <button id="chatbotSend">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://www.payhere.lk/lib/payhere.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<script>
    // API Base URL
    const API_BASE_URL = "http://localhost:8080/api/v1";
    const APPOINTMENT_API_URL = "http://localhost:8080/api/v1/appointments";
    const subcategoryContainer = document.getElementById('subcategory-container');
    const gigsContainer = document.getElementById('gigs-container');
    const categoryList = document.getElementById('category-list');
    const loader = document.getElementById('loader');
    const imageModal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const closeModal = document.querySelector('.close-modal');
    const backButton = document.getElementById('back-button');
    
    // Chat Bot Elements
    const chatbotToggle = document.getElementById('chatbotToggle');
    const chatbotContainer = document.getElementById('chatbotContainer');
    const chatbotMessages = document.getElementById('chatbotMessages');
    const chatbotInput = document.getElementById('chatbotInput');
    const chatbotSend = document.getElementById('chatbotSend');
    const chatbotCloseBtn = document.querySelector('.chatbot-close-btn');

    // Helper function to generate image URL
    function getImageUrl(imagePath, type = 'category') {
        if (!imagePath) {
            return type === 'category'
                ? 'https://source.unsplash.com/random/600x400/?category'
                : 'https://source.unsplash.com/random/600x400/?subcategory';
        }
        return `http://localhost:8080/${imagePath}`;
    }

    function getHeaders(isMultipart = false) {
        const authToken = localStorage.getItem("authToken");
        if (!authToken) {
            Swal.fire({
                title: "Unauthorized",
                text: "You are not authenticated. Please login.",
                icon: "error",
                confirmButtonText: "Login"
            }).then(() => {
                window.location.href = "/login.html";
            });
            return {};
        }

        return isMultipart
            ? { "Authorization": `Bearer ${authToken}` }
            : {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${authToken}`,
            };
    }

    // Function to fetch categories
    async function fetchCategories() {
        try {
            showLoader();

            const response = await fetch(`${API_BASE_URL}/category/getAll`, {
                method: "GET",
                headers: getHeaders(),
            });

            if (!response.ok) {
                throw new Error("Failed to fetch categories");
            }

            const data = await response.json();
            displayCategories(data.data);

            // Load first category's subcategories by default if available
            if (data.data.length > 0) {
                fetchSubcategories(data.data[0].id);
                // Highlight first category
                document.querySelector('.nav-category-item').classList.add('active');
            }
        } catch (error) {
            console.error("Error fetching categories:", error);
            showError("Unable to load categories");
        } finally {
            hideLoader();
        }
    }

    // Function to fetch and display subcategories
    async function fetchSubcategories(categoryId) {
        try {
            showLoader();
            subcategoryContainer.innerHTML = '';
            gigsContainer.classList.add('d-none');
            backButton.classList.remove('show');

            const response = await fetch(`${API_BASE_URL}/category/${categoryId}/subcategories`, {
                method: "GET",
                headers: getHeaders(),
            });

            if (!response.ok) {
                throw new Error("Failed to fetch subcategories");
            }

            const subcategories = await response.json();
            displaySubcategoryCards(subcategories);

            if (subcategories.length === 0) {
                showEmptyState();
            }
        } catch (error) {
            console.error("Error fetching subcategories:", error);
            showError("Unable to load subcategories");
        } finally {
            hideLoader();
        }
    }

    // Function to fetch and display gigs for a subcategory
    async function fetchGigs(subCategoryId) {
        try {
            showLoader();
            subcategoryContainer.classList.add('d-none');
            gigsContainer.classList.remove('d-none');
            backButton.classList.add('show');

            const response = await fetch(`${API_BASE_URL}/subcategory/${subCategoryId}/gigs`, {
                method: "GET",
                headers: getHeaders(),
            });

            if (!response.ok) {
                throw new Error("Failed to fetch gigs");
            }

            const gigs = await response.json();
            displayGigs(gigs);

            if (gigs.length === 0) {
                showEmptyGigsState();
            }
        } catch (error) {
            console.error("Error fetching gigs:", error);
            showError("Unable to load gigs");
        } finally {
            hideLoader();
        }
    }

    // Function to display categories in the navbar
    function displayCategories(categories) {
        categoryList.innerHTML = ""; // Clear existing items

        categories.forEach((category, index) => {
            const categoryItem = document.createElement("li");
            categoryItem.classList.add("nav-item");

            const categoryLink = document.createElement("a");
            categoryLink.classList.add("nav-category-item", "nav-link");
            categoryLink.href = "#";
            categoryLink.textContent = category.name;
            categoryLink.dataset.categoryId = category.id;
            categoryLink.style.animationDelay = `${index * 0.1}s`;

            // Add animation to each nav item
            categoryLink.classList.add("animate__animated", "animate__fadeInRight");

            categoryItem.appendChild(categoryLink);
            categoryList.appendChild(categoryItem);

            // Event listener to fetch subcategories
            categoryLink.addEventListener("click", (event) => {
                event.preventDefault();
                // Remove active class from all categories
                document.querySelectorAll('.nav-category-item').forEach(link => {
                    link.classList.remove('active');
                });
                // Add active class to clicked category
                categoryLink.classList.add('active');

                // Fetch and display subcategories with animation
                animateContentTransition(() => {
                    fetchSubcategories(category.id);
                });
            });
        });
    }

    // Function to display subcategory cards
    function displaySubcategoryCards(subcategories) {
        subcategoryContainer.innerHTML = '';

        subcategories.forEach((subcategory, index) => {
            const delay = index * 0.1;
            const imageUrl = getImageUrl(subcategory.image, 'subcategory');

            const cardColumn = document.createElement("div");
            cardColumn.classList.add(
                "col-lg-3",
                "col-md-5",
                "animate__animated",
                "animate__fadeInUp"
            );
            cardColumn.style.animationDelay = `${delay}s`;

            const card = document.createElement("div");
            card.classList.add("category-card", "h-100");
            card.dataset.subcategoryId = subcategory.id;

            card.innerHTML = `
                    <img src="${imageUrl}" alt="${subcategory.name}" class="img-fluid">
                    <h3>${subcategory.name}</h3>
                    <p>${subcategory.description || "No description available"}</p>
                `;

            // Add click event to show image modal
            card.querySelector('img').addEventListener('click', (e) => {
                e.stopPropagation();
                modalImage.src = imageUrl;
                modalImage.alt = subcategory.name;
                imageModal.classList.add('show');
                
                // Auto-open chat bot and send message
                openChatBot();
                setTimeout(() => {
                    addBotMessage(`Would you like to know more about ${subcategory.name}? I can help you find the right professional for your needs!`);
                }, 1000);
            });

            // Add click event to fetch gigs
            card.addEventListener('click', (e) => {
                if (e.target.tagName !== 'IMG') {
                    animateContentTransition(() => {
                        fetchGigs(subcategory.id);
                    });
                }
            });

            cardColumn.appendChild(card);
            subcategoryContainer.appendChild(cardColumn);
        });
    }


    // Function to display gig cards
   // Function to display gig cards
function displayGigs(gigs) {
    gigsContainer.innerHTML = '';

    gigs.forEach((gig, index) => {
        const delay = index * 0.1;
        const imageUrl = gig.image ? `http://localhost:8080/${gig.image}` : 'https://source.unsplash.com/random/100x50/?professional';

        const cardColumn = document.createElement("div");
        cardColumn.classList.add(
            "col-lg-3",
            "col-md-3",
            "animate__animated",
            "animate__fadeInUp"
        );
        cardColumn.style.animationDelay = `${delay}s`;

        const card = document.createElement("div");
        card.classList.add("gig-card", "h-100");
        card.dataset.gigId = gig.id;

        // Simple star display (not clickable stars, just showing the count)
        const starRatingHTML = `
            <div class="gig-rating" data-gig-id="${gig.id}">
                <i class="fas fa-star text-warning"></i>
                <span class="ms-1">${gig.star || 0}</span>
                <button class="btn btn-sm btn-outline-primary ms-2 give-star">
                    <i class="fas fa-thumbs-up"></i> Like
                </button>
            </div>
        `;

        card.innerHTML = `
                <div class="gig-card-header">
                    <img src="${imageUrl}" alt="${gig.fullName}" class="img-fluid gig-image">
                    <h3>${gig.fullName}</h3>
                    ${starRatingHTML}
                </div>
                <div class="gig-card-body">
                    <p><i class="fas fa-graduation-cap"></i> ${gig.degree}</p>
                    <p><i class="fas fa-briefcase"></i> ${gig.experience} years experience</p>
                    <p><i class="fas fa-money-bill-wave"></i> Rs.${gig.amountCharge.toFixed(2)} per session</p>
                    <p><i class="fas fa-map-marker-alt"></i> ${gig.location}</p>
                    <p><i class="fas fa-phone"></i> ${gig.contactNumber}</p>
                    <p><i class="fas fa-calendar-check"></i> Max ${gig.maxAppointmentsPerDay} appointments/day</p>
                </div>
                <div class="gig-card-footer">
                    <button class="btn btn-primary book-appointment">Book Appointment</button>
                </div>
        `;
        card.querySelector('.book-appointment').addEventListener('click', () => {
    bookAppointment(gig); // Call your function with current gig
});

        card.querySelector('.give-star').addEventListener('click', async (e) => {
    e.stopPropagation();
    // Add event listener for the Book Appointment button

    
    
    // First verify user email
    const { value: userEmail } = await Swal.fire({
        title: 'Verify Your Email',
        input: 'email',
        inputPlaceholder: 'your@email.com',
        showCancelButton: true,
        confirmButtonText: 'Verify',
        confirmButtonColor: '#4361ee',
        inputValidator: (value) => {
            if (!value) {
                return 'You need to enter your email!';
            }
            if (!/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(value)) {
                return 'Please enter a valid email address!';
            }
        }
    });

    if (!userEmail) return;

    try {
        // Show loading state
        Swal.fire({
            title: 'Processing...',
            text: 'Verifying your information',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Check if user exists by email
        const userResponse = await fetch(`${API_BASE_URL}/user/email/${encodeURIComponent(userEmail)}`, {
            method: "GET",
            headers: getHeaders()
        });

        if (!userResponse.ok) {
            throw new Error("User not found with this email.");
        }

        const userData = await userResponse.json();
        const userId = userData.data.id;

        // Submit the review (which will increment star count by 1)
        const reviewResponse = await fetch(`${API_BASE_URL}/reviews`, {
            method: "POST",
            headers: getHeaders(),
            body: JSON.stringify({
                userId: userId,
                gigId: gig.id
                // No rating field needed as per your backend
            })
        });

        if (!reviewResponse.ok) {
            const errorText = await reviewResponse.text();
            throw new Error(errorText || "Failed to submit star");
        }

        // Close loading dialog
        Swal.close();

        // Update the UI
        const starCountElement = card.querySelector('.gig-rating span');
        const currentStars = parseInt(starCountElement.textContent) || 0;
        starCountElement.textContent = currentStars + 1;

        // Disable the button to prevent multiple likes
        const likeButton = card.querySelector('.give-star');
        likeButton.disabled = true;
        likeButton.innerHTML = '<i class="fas fa-check"></i> Liked';
        likeButton.classList.remove('btn-outline-primary');
        likeButton.classList.add('btn-success');

        Swal.fire({
            icon: 'success',
            title: 'Thank You!',
            text: `You gave a star to ${gig.fullName}.`,
            confirmButtonColor: '#4361ee'
        });

    } catch (error) {
        console.error("Star error:", error);
        Swal.fire({
            icon: 'error',
            title: 'Failed to Give Star',
            text: error.message || "An error occurred while giving a star",
            confirmButtonColor: '#4361ee'
        });
    }
});

        cardColumn.appendChild(card);
        gigsContainer.appendChild(cardColumn);
    });
} // Function to handle appointment booking
   

async function bookAppointment(gig) {
        try {
            // First show email search dialog
            const { value: userEmail } = await Swal.fire({
                title: 'Enter Your Email',
                input: 'email',
                inputPlaceholder: 'your@email.com',
                showCancelButton: true,
                confirmButtonText: 'Search',
                confirmButtonColor: '#4361ee',
                preConfirm: (email) => {
                    if (!email) {
                        Swal.showValidationMessage('Please enter your email');
                        return false;
                    }
                    return email;
                }
            });
            
            if (!userEmail) return;
            
            // Show loading state while searching for user
            Swal.fire({
                title: 'Searching...',
                text: 'Looking up user information',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Get user details by email
            const userResponse = await fetch(`${API_BASE_URL}/user/email/${encodeURIComponent(userEmail)}`, {
                method: "GET",
                headers: getHeaders()
            });
            
            if (!userResponse.ok) {
                const errorText = await userResponse.text();
                throw new Error(errorText || "User not found");
            }
            
            const userData = await userResponse.json();
            const user = userData.data;
            
            // Close the loading dialog
            Swal.close();
            
            // Show appointment booking form with user details
            const { value: formValues } = await Swal.fire({
                title: `Book Appointment with ${gig.fullName}`,
                html: `
                    <div class="text-start">
                        <p><strong>Your Details:</strong></p>
                        <p>Name: ${user.name || 'N/A'}</p>
                        <p>Email: ${user.email}</p>
                        <hr>
                        <p><strong>Service Details:</strong></p>
                        <p>Professional: ${gig.fullName}</p>
                        <p>Rate: Rs.${gig.amountCharge.toFixed(2)} per session</p>
                        <p>Contact: ${gig.contactNumber}</p>
                        <div class="mb-3">
                            <label for="appointment-date" class="form-label">Select Date</label>
                            <input type="date" id="appointment-date" class="form-control" min="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="mb-3">
                            <label for="appointment-time" class="form-label">Select Time</label>
                            <input type="time" id="appointment-time" class="form-control">
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: "Confirm Booking",
                confirmButtonColor: "#4361ee",
                preConfirm: () => {
                    const date = document.getElementById('appointment-date').value;
                    const time = document.getElementById('appointment-time').value;
                    
                    if (!date || !time) {
                        Swal.showValidationMessage("Please select both date and time");
                        return false;
                    }
                    
                    return { date, time };
                }
            });
            
            if (!formValues) return;
            
            // Create appointment data with both user ID and gig ID
            const appointmentData = {
                gigId: gig.id,
                userId: user.id,
                appointmentTime: `${formValues.date}T${formValues.time}:00`,
                status: "PENDING"
            };

            // Show loading state while booking
            Swal.fire({
                title: 'Processing...',
                text: 'Booking your appointment',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Book appointment
            const bookingResponse = await fetch(`${APPOINTMENT_API_URL}/book`, {
                method: "POST",
                headers: getHeaders(),
                body: JSON.stringify(appointmentData)
            });
            
            // First get the response as text
            const responseText = await bookingResponse.text();
            
            // Then try to parse it as JSON
            let responseData;
            try {
                responseData = JSON.parse(responseText);
            } catch (e) {
                // If parsing fails, use the text as the message
                responseData = { message: responseText };
            }
            
            if (!bookingResponse.ok) {
                throw new Error(responseData.message || "Booking failed");
            }
            
            // Close loading dialog
            Swal.close();
            
            // Show success message with cancellation option
            const { value: action } = await Swal.fire({
                title: "Appointment Booked!",
                html: `
                    <div class="text-start">
                        <p>Your appointment with ${gig.fullName} is confirmed for:</p>
                        <p><strong>${formValues.date} at ${formValues.time}</strong></p>
                        ${responseData.appointmentId ? `<p>Appointment ID: ${responseData.appointmentId}</p>` : ''}
                    </div>
                `,
                icon: "success",
                showCancelButton: true,
                confirmButtonText: 'Done',
                cancelButtonText: 'Cancel Appointment',
                cancelButtonColor: '#d33'
            });
            
            if (action === false && responseData.appointmentId) {
                await cancelAppointment(responseData.appointmentId, gig.fullName);
            }
            
        } catch (error) {
            console.error("Booking error:", error);
            Swal.fire({
                icon: 'error',
                title: 'Booking Failed',
                text: error.message || "An error occurred during booking",
                confirmButtonColor: '#4361ee'
            });
        }
    }

    // Function to cancel appointment
    async function cancelAppointment(appointmentId, professionalName) {
        try {
            const { isConfirmed } = await Swal.fire({
                title: 'Cancel Appointment?',
                html: `Are you sure you want to cancel your appointment with <strong>${professionalName}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, cancel it!'
            });
            
            if (!isConfirmed) return;
            
            // Show loading state
            Swal.fire({
                title: 'Processing...',
                text: 'Cancelling your appointment',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Send cancellation request - changed to use appointmentId
            const response = await fetch(`${APPOINTMENT_API_URL}/cancel/${appointmentId}`, {
                method: "PUT",
                headers: getHeaders(),
                body: JSON.stringify({
                    // Include any required data
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || "Failed to cancel appointment");
            }

            // Show success message
            await Swal.fire({
                title: "Cancelled!",
                text: "Your appointment has been successfully cancelled.",
                icon: "success",
                confirmButtonColor: '#4361ee'
            });
            
        } catch (error) {
            console.error("Cancellation error:", error);
            Swal.fire({
                title: 'Cancellation Failed',
                text: error.message || "Could not cancel appointment",
                icon: 'error',
                confirmButtonColor: '#4361ee'
            });
        }
    }

    // Show empty state for subcategories
    function showEmptyState() {
        const emptyState = document.createElement("div");
        emptyState.classList.add("col-12", "empty-state");
        emptyState.innerHTML = `
                <i class="fas fa-folder-open"></i>
                <h3>No Subcategories Found</h3>
                <p>This category does not have any subcategories yet.</p>
            `;
        subcategoryContainer.appendChild(emptyState);
    }

    // Show empty state for gigs
    function showEmptyGigsState() {
        const emptyState = document.createElement("div");
        emptyState.classList.add("col-12", "empty-state");
        emptyState.innerHTML = `
                <i class="fas fa-calendar-times"></i>
                <h3>No Gigs Available</h3>
                <p>This subcategory does not have any available gigs at the moment.</p>
            `;
        gigsContainer.appendChild(emptyState);
    }

    // Show loader
    function showLoader() {
        loader.classList.remove('d-none');
    }

    // Hide loader
    function hideLoader() {
        loader.classList.add('d-none');
    }

    // Show error message
    function showError(message) {
        Swal.fire({
            title: 'Error',
            text: message,
            icon: 'error',
            confirmButtonText: 'OK',
            confirmButtonColor: '#4361ee'
        });
    }
// Function to create and show custom payment form with improved design
function showCustomPaymentForm(appointmentId, appointmentData) {
    // Debug log to see what data we're working with
    console.log("Opening payment form with data:", { appointmentId, appointmentData });
    
    // Create overlay element
    const overlay = document.createElement('div');
    overlay.id = 'paymentOverlay';
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.zIndex = '1000';
    
    // Format date and amount
    const appointmentDate = new Date(appointmentData.dateTime);
    const formattedDate = appointmentDate.toLocaleDateString();
    const formattedTime = appointmentDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    // Clean up the amount value
    let cleanAmount = "0.00";
    if (appointmentData.amountCharge) {
        cleanAmount = appointmentData.amountCharge.toString().replace(/[^0-9.]/g, '');
    }
    
    // Create payment form container with enhanced design
    const paymentForm = document.createElement('div');
    paymentForm.id = 'paymentForm';
    paymentForm.style.backgroundColor = '#fff';
    paymentForm.style.borderRadius = '12px';
    paymentForm.style.boxShadow = '0 8px 24px rgba(0, 0, 0, 0.25)';
    paymentForm.style.width = '90%';
    paymentForm.style.maxWidth = '550px';
    paymentForm.style.padding = '0';
    paymentForm.style.overflow = 'hidden';
    paymentForm.style.animation = 'fadeInScale 0.4s ease-out forwards';
    
    // Add animation styles
    const styleElement = document.createElement('style');
    styleElement.textContent = `
        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .payment-method {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .payment-method:hover:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(74, 111, 165, 0.05);
            border-radius: 6px;
        }
        
        .payment-method.selected {
            border-color: #4a6fa5 !important;
            background-color: #f0f7ff !important;
            box-shadow: 0 2px 8px rgba(74, 111, 165, 0.2);
        }
        
        #payNowButton {
            transition: all 0.3s ease;
        }
        
        #payNowButton:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(styleElement);
    
    // Payment form content with improved design
    paymentForm.innerHTML = `
        <div style="background: linear-gradient(135deg, #4a6fa5, #3a5a8c); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Payment Details</h2>
        </div>
        
        <div style="padding: 25px; background-color: #fff;">
            <div style="margin-bottom: 18px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; color: #444; font-size: 15px;">Appointment:</span>
                <span style="color: #333; font-size: 15px;">${appointmentData.gigName}</span>
            </div>
            
            <div style="margin-bottom: 18px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; color: #444; font-size: 15px;">Date & Time:</span>
                <span style="color: #333; font-size: 15px;">${formattedDate} at ${formattedTime}</span>
            </div>
            
            <div style="margin-bottom: 18px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600; color: #444; font-size: 15px;">Appointment ID:</span>
                <span style="color: #333; font-size: 15px;">${appointmentId}</span>
            </div>
            
            <div style="margin-top: 28px; padding-top: 18px; border-top: 1px solid #eee; display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; color: #333;">
                <span>Total Amount:</span>
                <span style="color: #4a6fa5;">LKR ${appointmentData.amountCharge}</span>
            </div>
        </div>
        
        <div style="padding: 25px; background-color: #f8fafd; border-top: 1px solid #eee;">
            <h3 style="font-size: 18px; margin-bottom: 20px; color: #333; font-weight: 600;">Select Payment Method</h3>
            
            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                
                <div class="payment-method" data-method="AMEX" style="flex: 1 1 calc(50% - 8px); min-width: 140px; max-width: 200px; text-align: center; padding: 20px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; background: white;">
                    <div class="payment-logo" style="height: 30px; margin-bottom: 12px; display: flex; justify-content: center; align-items: center;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/American_Express_logo.svg/1200px-American_Express_logo.svg.png" alt="American Express" style="height: 100%; width: auto;" onerror="this.src='https://via.placeholder.com/80x50?text=AMEX'">
                    </div>
                    <div style="font-weight: 600; color: #333; font-size: 14px;">Visa</div>
                </div>
                
                <div class="payment-method" data-method="ONLINE_BANKING" style="flex: 1 1 calc(50% - 8px); min-width: 140px; max-width: 200px; text-align: center; padding: 20px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; background: white;">
                    <div class="payment-logo" style="height: 30px; margin-bottom: 12px; display: flex; justify-content: center; align-items: center;">
                        <img src="https://cdn-icons-png.flaticon.com/512/265/265680.png" alt="Online Banking" style="height: 100%; width: auto;" onerror="this.src='https://via.placeholder.com/80x50?text=ONLINE+BANKING'">
                    </div>
                    <div style="font-weight: 600; color: #333; font-size: 14px;">Online Banking</div>
                </div>
                <div class="payment-method" data-method="AMEX" style="flex: 1 1 calc(50% - 8px); min-width: 140px; max-width: 200px; text-align: center; padding: 20px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; background: white;">
                    <div class="payment-logo" style="height: 30px; margin-bottom: 12px; display: flex; justify-content: center; align-items: center;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/American_Express_logo.svg/1200px-American_Express_logo.svg.png" alt="American Express" style="height: 100%; width: auto;" onerror="this.src='https://via.placeholder.com/80x50?text=AMEX'">
                    </div>
                    <div style="font-weight: 600; color: #333; font-size: 14px;">Amazon</div>
                </div>
            </div>
        </div>
        
        <div style="padding: 25px; text-align: center; background-color: #fff; border-top: 1px solid #eee;">
            <button id="payNowButton" disabled style="width: 60%; background-color: #ddd; color: #888; padding: 14px 30px; border: none; border-radius: 50px; cursor: not-allowed; font-weight: bold; font-size: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                Pay Now
            </button>
            <button id="cancelPaymentButton" style="background-color: transparent; color: #777; padding: 14px 25px; border: none; cursor: pointer; font-size: 16px; margin-left: 10px; transition: all 0.3s ease;">
                Cancel
            </button>
        </div>
    `;
    
    // Add form to overlay and overlay to document
    overlay.appendChild(paymentForm);
    document.body.appendChild(overlay);
    
    // Add event listeners to payment methods
    let selectedMethod = null;
    const paymentMethods = document.querySelectorAll('.payment-method');
    const payNowButton = document.getElementById('payNowButton');
    
    paymentMethods.forEach(method => {
        method.addEventListener('click', function() {
            // Remove selected class from all methods
            paymentMethods.forEach(m => {
                m.classList.remove('selected');
            });
            
            // Add selected class to clicked method
            this.classList.add('selected');
            
            // Store selected method
            selectedMethod = this.getAttribute('data-method');
            
            // Enable pay button with animation
            payNowButton.disabled = false;
            payNowButton.style.backgroundColor = '#4CAF50';
            payNowButton.style.color = 'white';
            payNowButton.style.cursor = 'pointer';
            payNowButton.style.boxShadow = '0 4px 8px rgba(76, 175, 80, 0.25)';
            
            // Add a subtle pulse animation
            payNowButton.style.animation = 'pulse 0.5s ease';
            setTimeout(() => {
                payNowButton.style.animation = '';
            }, 500);
        });
    });
    
    // Add click event to pay now button
    payNowButton.addEventListener('click', function() {
        if (selectedMethod) {
            // Show loading indicator
            this.innerHTML = '<span style="display: inline-block; margin-right: 10px;">Processing</span> <div class="loader" style="display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 0.6s linear infinite;"></div>';
            this.disabled = true;
            
            // Extract all necessary data for payment
            processPayment(appointmentId, appointmentData, selectedMethod);
        }
    });
    
    // Add click event to cancel button
    document.getElementById('cancelPaymentButton').addEventListener('click', closePaymentForm);
    document.getElementById('cancelPaymentButton').addEventListener('mouseover', function() {
        this.style.color = '#333';
    });
    document.getElementById('cancelPaymentButton').addEventListener('mouseout', function() {
        this.style.color = '#777';
    });
    
    // Add click event to overlay (close when clicking outside)
    overlay.addEventListener('click', function(event) {
        if (event.target === overlay) {
            closePaymentForm();
        }
    });
    
    // Function to close payment form with animation
    function closePaymentForm() {
        overlay.style.opacity = '1';
        paymentForm.style.animation = 'fadeInScale 0.3s ease-in reverse forwards';
        
        setTimeout(() => {
            document.body.removeChild(overlay);
        }, 300);

        // Fade out overlay
        overlay.style.transition = 'opacity 0.3s ease';
        overlay.style.opacity = '0';
    }
    
    // Function to handle payment processing
    function processPayment(appointmentId, appointmentData, selectedMethod) {
        // Get user ID from localStorage
        const userId = localStorage.getItem('userId');
        
        // Determine gigId from appointmentData
        let gigId = null;
        
        // First check if gigId exists directly in appointmentData
        if (appointmentData.gigId) {
            gigId = appointmentData.gigId;
        } 
        // Check if there's a gig object
        else if (appointmentData.gig && appointmentData.gig.id) {
            gigId = appointmentData.gig.id;
        }
        // Try to extract from gigName (if it contains a number at the end)
        else if (appointmentData.gigName) {
            const match = appointmentData.gigName.match(/(\d+)$/);
            if (match && match[1]) {
                gigId = match[1];
            }
        }
        
        // Clean up the amount value
        let cleanAmount = 0;
        if (appointmentData.amountCharge) {
            cleanAmount = appointmentData.amountCharge.toString().replace(/[^0-9.]/g, '');
            cleanAmount = parseFloat(cleanAmount);
        }
        
        // Prepare payment data
        const paymentData = {
            availabilityId: appointmentId,
            userId: userId,
            gigId: gigId,
            amount: cleanAmount
        };
        
        console.log("Payment request data:", paymentData);
        
        // Call backend to process payment
        makeBackendPayment(paymentData)
            .then(result => {
                if (result.success) {
                    console.log("Backend payment successful:", result);
                    closePaymentForm();
                    
                    // Process with PayHere
                    initializePayHerePayment(appointmentId, appointmentData, selectedMethod);
                } else {
                    // Display error
                    alert("Payment processing failed: " + (result.error || "Unknown error"));
                    
                    // Reset button
                    payNowButton.innerHTML = 'Pay Now';
                    payNowButton.disabled = false;
                }
            })
            .catch(error => {
                console.error("Payment error:", error);
                alert("Payment error: " + error.message);
                
                // Reset button
                payNowButton.innerHTML = 'Pay Now';
                payNowButton.disabled = false;
            });
    }
}

// Function to handle payment processing
function processPayment(appointmentId, appointmentData, selectedMethod) {
    // Get user ID from localStorage
    const userId = localStorage.getItem('userId');
    
    // Determine gigId from appointmentData
    let gigId = null;
    
    // First check if gigId exists directly in appointmentData
    if (appointmentData.gigId) {
        gigId = appointmentData.gigId;
    } 
    // Check if there's a gig object
    else if (appointmentData.gig && appointmentData.gig.id) {
        gigId = appointmentData.gig.id;
    }
    // If you have gigName and a separate API to fetch gigId by name
    else if (appointmentData.gigName) {
        // Option 1: Extract ID if gigName is in format "Name #123"
        const match = appointmentData.gigName.match(/(\d+)$/);
        if (match && match[1]) {
            gigId = match[1];
        } 
        // Option 2: Make an API call to get gigId by name
        else {
            // This needs to be done asynchronously - we'll return a promise
            return fetchGigIdByName(appointmentData.gigName)
                .then(id => {
                    if (id) {
                        gigId = id;
                        return continuePaymentProcess(appointmentId, appointmentData, userId, gigId, selectedMethod);
                    } else {
                        throw new Error("Could not find gigId for: " + appointmentData.gigName);
                    }
                });
        }
    }
    
    // If we're here, we either have gigId or couldn't get it
    return continuePaymentProcess(appointmentId, appointmentData, userId, gigId, selectedMethod);
}

// Helper function to get gigId by name
async function fetchGigIdByName(gigName) {
    try {
        const authToken = localStorage.getItem('authToken');
        
        if (!authToken) {
            throw new Error('Authentication token not found');
        }
        
        // Call your API endpoint that can find a gig by name
        const response = await fetch(`http://localhost:8080/api/v1/gig/search?name=${encodeURIComponent(gigName)}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch gig id (${response.status})`);
        }
        
        const results = await response.json();
        
        // Check if we got results and return the id of the first matching gig
        if (results && results.length > 0) {
            return results[0].id;
        }
        
        return null;
    } catch (error) {
        console.error('Error fetching gig id by name:', error);
        return null;
    }
}

// Continue the payment process after determining gigId
function continuePaymentProcess(appointmentId, appointmentData, userId, gigId, selectedMethod) {
    // Clean up the amount value
    let cleanAmount = 0;
    if (appointmentData.amountCharge) {
        cleanAmount = appointmentData.amountCharge.toString().replace(/[^0-9.]/g, '');
        cleanAmount = parseFloat(cleanAmount);
    }
    
    // Prepare payment data
    const paymentData = {
        availabilityId: appointmentId,
        userId: userId,
        gigId: gigId,
        amount: cleanAmount,
        gigName: appointmentData.gigName  // Keep the original gigName for reference
    };
    
    console.log("Payment request data:", paymentData);
    
    // Call backend to process payment
    return makeBackendPayment(paymentData)
        .then(result => {
            if (result.success) {
                console.log("Backend payment successful:", result);
                closePaymentForm();
                
                // Process with PayHere
                initializePayHerePayment(appointmentId, appointmentData, selectedMethod);
                return true;
            } else {
                // Display error
                alert("Payment processing failed: " + (result.error || "Unknown error"));
                
                // Reset button
                const payNowButton = document.getElementById('payNowButton');
                payNowButton.innerHTML = 'Pay Now';
                payNowButton.disabled = false;
                return false;
            }
        })
        .catch(error => {
            console.error("Payment error:", error);
            alert("Payment error: " + error.message);
            
            // Reset button
            const payNowButton = document.getElementById('payNowButton');
            payNowButton.innerHTML = 'Pay Now';
            payNowButton.disabled = false;
            return false;
        });
}
// Function to make the backend payment API call
async function makeBackendPayment(paymentData) {
    try {
        const authToken = localStorage.getItem('authToken');
        
        if (!authToken) {
            throw new Error('Authentication token not found');
        }
        
        // Format data to match backend expectations
        const formattedData = {
            availabilityId: paymentData.availabilityId ? String(paymentData.availabilityId) : null,
            userId: paymentData.userId ? String(paymentData.userId) : null,
            gigId: paymentData.gigId ? String(paymentData.gigId) : null,
            amount: paymentData.amount ? Number(paymentData.amount) : 0
        };
        
        console.log("Sending payment data to backend:", formattedData);
        
        // Show processing alert
        Swal.fire({
            title: 'Processing Payment',
            html: 'Please wait while we process your payment...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        const response = await fetch('http://localhost:8080/api/v1/payment/pay', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(formattedData)
        });
        
        if (!response.ok) {
            let errorText;
            try {
                const errorData = await response.json();
                errorText = errorData.message || JSON.stringify(errorData);
            } catch (e) {
                errorText = await response.text();
            }
            
            console.error("Server error:", {
                status: response.status,
                statusText: response.statusText,
                body: errorText
            });
            
            throw new Error(errorText || `Payment failed (${response.status})`);
        }
        
        const result = await response.json();
        
        // Show success message
        await Swal.fire({
            icon: 'success',
            title: 'Payment Successful!',
            html: `
                <div style="text-align: left; margin-top: 20px;">
                    <p><strong>Amount:</strong> LKR ${paymentData.amount.toLocaleString()}</p>
                    
                    <p><strong>Reference:</strong> ${result.id || 'N/A'}</p>
                </div>
            `,
            confirmButtonText: 'Done',
            confirmButtonColor: '#4CAF50'
        });
        
        return { success: true, data: result };
        
    } catch (error) {
        console.error('Payment processing error:', error);
        
        // Show error message
        await Swal.fire({
            icon: 'error',
            title: 'Payment Failed',
            html: `
                <div style="text-align: left; margin-top: 20px;">
                    <p>${error.message}</p>
                    <p>Please try again or contact support if the problem persists.</p>
                </div>
            `,
            confirmButtonText: 'Try Again',
            confirmButtonColor: '#f44336'
        });
        
        return { success: false, error: error.message };
    }
}

// Example usage:
// makeBackendPayment({
//     availabilityId: '123',
//     userId: '456',
//     gigId: '789',
//     amount: 10000,
//     gigName: 'Professional Photography'
// });
// Function to initialize PayHere payment
function initializePayHerePayment(appointmentId, appointmentData, paymentMethod) {
    // Get user data from localStorage
    const userId = localStorage.getItem('userId');
    const userEmail = localStorage.getItem('userEmail') || '';
    const userName = localStorage.getItem('userName') || '';
    const userPhone = localStorage.getItem('userPhone') || '';
    
    // Clean up the amount value
    let cleanAmount = "0.00";
    if (appointmentData.amountCharge) {
        cleanAmount = appointmentData.amountCharge.toString().replace(/[^0-9.]/g, '');
    }
    
    // Format first and last name
    let firstName = "", lastName = "";
    if (userName) {
        const nameParts = userName.split(' ');
        firstName = nameParts[0] || "";
        lastName = nameParts.slice(1).join(' ') || "";
    }
    
    // Build PayHere payment object
    const payment = {
        sandbox: true, // Set to false in production
        merchant_id: "1230106", // Replace with your actual Payhere merchant ID
        return_url: window.location.origin + "/payment-success",
        cancel_url: window.location.origin + "/payment-cancelled",
        notify_url: "http://localhost:8080/api/v1/payment/payhere",
        order_id: appointmentId,
        items: appointmentData.gigName,
        amount: cleanAmount,
        currency: "LKR",
        first_name: firstName,
        last_name: lastName,
        email: userEmail,
        phone: userPhone,
        address: "",
        city: "",
        country: "Sri Lanka",
        delivery_address: "",
        delivery_city: "",
        delivery_country: "Sri Lanka",
        custom_1: userId,
        custom_2: appointmentId,
        method: paymentMethod // VISA, MASTER, AMEX, ONLINE_BANKING
    };

    console.log("Initializing PayHere with data:", payment);

    // Show PayHere payment window
    if (typeof payhere !== 'undefined') {
        payhere.startPayment(payment);
    } else {
        console.error("PayHere.js is not loaded");
        alert("Payment gateway not available. Please ensure PayHere.js is loaded properly.");
    }
}

// Function to display notifications including appointments with Payment buttons
function displayNotifications(appointments) {
    const notificationList = document.getElementById('notificationList');
    const notificationCount = document.getElementById('notificationCount');
    
    // Clear existing notifications (except the header)
    const itemsToRemove = notificationList.querySelectorAll('.notification-item, .notification-empty');
    itemsToRemove.forEach(item => item.remove());
    
    if (appointments.length === 0) {
        const emptyItem = document.createElement('li');
        emptyItem.className = 'notification-empty';
        emptyItem.textContent = 'No appointments found';
        notificationList.appendChild(emptyItem);
        notificationCount.style.display = 'none';
        return;
    }
    
    // Sort appointments by date (newest first)
    appointments.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
    
    // Add each appointment as a notification item
    appointments.forEach(appointment => {
        const notificationItem = document.createElement('li');
        notificationItem.className = 'notification-item';
        
        // Format the date/time
        const appointmentDate = new Date(appointment.dateTime);
        const formattedDate = appointmentDate.toLocaleDateString();
        const formattedTime = appointmentDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Determine status class
        let statusClass = '';
        if (appointment.status === 'PENDING') statusClass = 'status-pending';
        else if (appointment.status === 'ACCEPTED') statusClass = 'status-accepted';
        else if (appointment.status === 'REJECTED') statusClass = 'status-rejected';
        else if (appointment.status === 'BOOKING') statusClass = 'status-booking';
        
        // Create the button container - only show pay button for BOOKING status
        const payButtonHtml = appointment.status === 'BOOKING' ? 
            `<div class="pay-button-container">
                <button class="pay-button" data-appointment-id="${appointment.id}">Pay</button>
            </div>` : '';
        
        notificationItem.innerHTML = `
            <div class="notification-gig">${appointment.gigName}</div>
            <div class="notification-gig">${appointment.gigId}</div>
            <div class="notification-user">
                <strong>Amount Charge:</strong> ${appointment.amountCharge}
            </div>
            <div class="notification-user">
                <strong>Your available ID:</strong> ${appointment.id}
            </div>

            <div class="notification-time">${formattedDate} at ${formattedTime}</div>
            <span class="notification-status ${statusClass}">${appointment.status}</span>
            ${payButtonHtml}
        `;
        
        // Add inline CSS for the pay button if present
        if (appointment.status === 'BOOKING') {
            const payButton = notificationItem.querySelector('.pay-button');
            payButton.style.backgroundColor = '#4CAF50';
            payButton.style.color = 'white';
            payButton.style.padding = '10px 18px';
            payButton.style.border = 'none';
            payButton.style.borderRadius = '50px';
            payButton.style.cursor = 'pointer';
            payButton.style.fontWeight = 'bold';
            payButton.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
            payButton.style.transition = 'all 0.3s ease';
            
            // Add hover effect
            payButton.onmouseover = function() {
                this.style.backgroundColor = '#45a049';
                this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                this.style.transform = 'translateY(-2px)';
            };
            payButton.onmouseout = function() {
                this.style.backgroundColor = '#4CAF50';
                this.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
                this.style.transform = 'translateY(0)';
            };

            // Add click event to show custom payment form
            payButton.onclick = function() {
                const appointmentId = this.getAttribute('data-appointment-id');
                showCustomPaymentForm(appointmentId, appointment);
            };
        }
        
        notificationList.appendChild(notificationItem);
    });
    
    // Update badge count
    notificationCount.textContent = appointments.length;
    notificationCount.style.display = appointments.length > 0 ? 'block' : 'none';
}

// Function to fetch appointments from the server using API
async function fetchUserAppointments() {
    try {
        const userId = localStorage.getItem('userId');
        const authToken = localStorage.getItem('authToken');
        
        if (!userId || !authToken) return;
        
        const response = await fetch(`http://localhost:8080/api/v1/gig/user/${userId}`, {
            headers: {
                "Authorization": `Bearer ${authToken}`
            }
        });
        
        if (!response.ok) throw new Error('Failed to fetch appointments');
        
        const appointments = await response.json();
        displayNotifications(appointments);
    } catch (error) {
        console.error('Error fetching appointments:', error);
    }
}

// Add this function to animate content transitions
function animateContentTransition(callback) {
    const subcategoryContainer = document.getElementById('subcategoryContainer');
    if (!subcategoryContainer) {
        if (callback) callback();
        return;
    }
    
    subcategoryContainer.style.opacity = '0';
    subcategoryContainer.style.transform = 'translateY(20px)';
    subcategoryContainer.style.transition = 'all 0.4s ease';

    setTimeout(() => {
        if (callback) callback();
        subcategoryContainer.style.opacity = '1';
        subcategoryContainer.style.transform = 'translateY(0)';
    }, 400);
}

// Add event listener to load appointments when document is ready
document.addEventListener('DOMContentLoaded', () => {
    fetchUserAppointments();
});

// Add PayHere script if not already included
function ensurePayHereScriptLoaded() {
    if (typeof payhere === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://www.payhere.lk/lib/payhere.js';
        script.async = true;
        document.head.appendChild(script);
        
        return new Promise((resolve) => {
            script.onload = () => {
                console.log("PayHere script loaded");
                resolve();
            };
        });
    }
    return Promise.resolve();
}

// Call this on page load
ensurePayHereScriptLoaded();
// Add this function to animate content transitions
function animateContentTransition(callback) {
    const subcategoryContainer = document.getElementById('subcategoryContainer');
    if (!subcategoryContainer) {
        if (callback) callback();
        return;
    }
    
    subcategoryContainer.style.opacity = '0';
    subcategoryContainer.style.transform = 'translateY(20px)';
    subcategoryContainer.style.transition = 'all 0.4s ease';

    setTimeout(() => {
        if (callback) callback();
        subcategoryContainer.style.opacity = '1';
        subcategoryContainer.style.transform = 'translateY(0)';
    }, 400);
}
// Initialize when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Add the PayHere script to the page if not already included
    if (typeof payhere === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://www.payhere.lk/lib/payhere.js';
        document.head.appendChild(script);
    }
    
    // Fetch appointments
    fetchUserAppointments();
    
    // Add CSS for payment methods hover effect
    const style = document.createElement('style');
    style.textContent = `
        .payment-method:hover {
            border-color: #4a6fa5 !important;
        }
    `;
    document.head.appendChild(style);
    
    // Optional: Refresh data periodically
    // setInterval(fetchUserAppointments, 60000); // Refresh every minute
});


    // Initialize WebSocket for real-time notifications
    function initializeWebSocket() {
        const authToken = localStorage.getItem('authToken');
        if (!authToken) return;
        
        const socket = new WebSocket(`ws://localhost:8080/ws/notifications?token=${authToken}`);
        
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'APPOINTMENT_UPDATE') {
                fetchUserAppointments(); // Refresh notifications
                
                // Special handling for accepted appointments
                if (data.status === 'ACCEPTED') {
                    showToastNotification(
                        `Your appointment with ${data.gigName} has been accepted!`, 
                        data.appointmentId,
                        data.amountCharge
                    );
                } else {
                    showToastNotification(data.message || "Appointment status updated");
                }
            }
        };
    }
    
    function showToastNotification(message, appointmentId = null, amount = null) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.style.zIndex = '11';
        
        let actionButton = '';
        if (appointmentId && amount) {
            actionButton = `
                <button class="btn btn-sm btn-success mt-2 auto-pay-toast-btn" 
                    data-appointment-id="${appointmentId}">
                    Auto Pay (Rs.${amount.toFixed(2)})
                </button>
            `;
        }
        
        toast.innerHTML = `
            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Notification</strong>
                    <button type="button" class="btn-close" 
                        onclick="this.parentElement.parentElement.parentElement.remove()"></button>
                </div>
                <div class="toast-body">
                    ${message}
                    ${actionButton}
                </div>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Add event listener to the button if it exists
        if (appointmentId) {
            const payBtn = toast.querySelector('.auto-pay-toast-btn');
            payBtn.addEventListener('click', () => {
                handleAutoPay(appointmentId);
                toast.remove();
            });
        }
        
        // Remove toast after 10 seconds (longer for important notifications)
        setTimeout(() => {
            if (document.body.contains(toast)) {
                toast.remove();
            }
        }, 10000);
    }
    /* ==================== CHAT BOT FUNCTIONS ==================== */

    // Open chat bot
    function openChatBot() {
        chatbotContainer.classList.add('open');
        chatbotToggle.style.display = 'none';
    }

    // Close chat bot
    function closeChatBot() {
        chatbotContainer.classList.remove('open');
        chatbotToggle.style.display = 'flex';
    }

    // Add bot message to chat
    function addBotMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', 'bot-message');
        messageElement.textContent = message;
        chatbotMessages.appendChild(messageElement);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    // Add user message to chat
    function addUserMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', 'user-message');
        messageElement.textContent = message;
        chatbotMessages.appendChild(messageElement);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    // Initialize chat bot with welcome message
    function initChatBot() {
        addBotMessage("Hello! I'm your appointment assistant. How can I help you today?");
        
        // Add quick action buttons
        setTimeout(() => {
            addQuickActions();
        }, 500);
    }

    // Add quick action buttons
    function addQuickActions() {
        const quickActions = document.createElement('div');
        quickActions.classList.add('quick-actions');
        
        quickActions.innerHTML = `
            <button class="quick-action-btn" data-action="book">Book Appointment</button>
            <button class="quick-action-btn" data-action="find">Find Professional</button>
            <button class="quick-action-btn" data-action="help">Get Help</button>
        `;
        
        chatbotMessages.appendChild(quickActions);
        
        // Add event listeners to quick action buttons
        document.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                handleQuickAction(action);
            });
        });
    }

    // Handle quick actions
    function handleQuickAction(action) {
        switch(action) {
            case 'book':
                addUserMessage("I want to book an appointment");
                setTimeout(() => {
                    addBotMessage("Great! Please click on a professional's profile and then click the 'Book Appointment' button.");
                }, 800);
                break;
            case 'find':
                addUserMessage("I need help finding a professional");
                setTimeout(() => {
                    addBotMessage("Browse through our categories to find the right professional. Click on any image for more details.");
                }, 800);
                break;
            case 'help':
                addUserMessage("I need help");
                setTimeout(() => {
                    addBotMessage("You can contact our support team at support@appointments.com or call +94 76 123 4567");
                }, 800);
                break;
        }
    }

    // Enhanced bot responses
    function generateBotResponse(userMessage) {
        userMessage = userMessage.toLowerCase();
        
        if (userMessage.includes('hello') || userMessage.includes('hi')) {
            return "Hello there! How can I assist you with your appointment today?";
        }
        else if (userMessage.includes('book') || userMessage.includes('appointment')) {
            return "To book an appointment: 1) Find a professional 2) Click their profile 3) Click 'Book Appointment'";
        }
        else if (userMessage.includes('cost') || userMessage.includes('price')) {
            return "Prices vary by professional. You'll see each professional's rates on their profile.";
        }
        else if (userMessage.includes('contact') || userMessage.includes('number')) {
            return "You can reach our support team at +94 76 123 4567 from 9AM to 5PM, Monday to Friday.";
        }
        else {
            const genericResponses = [
                "I can help you book appointments or find professionals. What do you need help with?",
                "Would you like me to guide you through the booking process?",
                "You can browse our categories to find the right professional for your needs.",
                "I'm here to help with any questions about our services."
            ];
            return genericResponses[Math.floor(Math.random() * genericResponses.length)];
        }
    }

    // Handle user input
    function handleUserInput() {
        const message = chatbotInput.value.trim();
        if (message) {
            addUserMessage(message);
            chatbotInput.value = '';
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.classList.add('typing-indicator');
            typingIndicator.innerHTML = `
                <span></span>
                <span></span>
                <span></span>
            `;
            chatbotMessages.appendChild(typingIndicator);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            
            // Bot response after delay
            setTimeout(() => {
                // Remove typing indicator
                if (chatbotMessages.contains(typingIndicator)) {
                    chatbotMessages.removeChild(typingIndicator);
                }
                
                const botResponse = generateBotResponse(message);
                addBotMessage(botResponse);
                
                // Add quick actions after certain responses
                if (message.includes('help') || message.includes('what can you do')) {
                    setTimeout(() => {
                        addQuickActions();
                    }, 500);
                }
            }, 1500);
        }
    }

    /* ==================== STYLE ENHANCEMENTS ==================== */
    // Add these styles to your existing style section
    const enhancedStyles = `
        /* Quick action buttons */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .quick-action-btn {
            background: #f1f1f1;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quick-action-btn:hover {
            background: #4361ee;
            color: white;
            transform: translateY(-2px);
        }
        
        /* Typing indicator */
        .typing-indicator {
            background: #f1f1f1;
            padding: 10px 15px;
            border-radius: 15px;
            align-self: flex-start;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            margin-right: 4px;
            opacity: 0.4;
        }
        
        .typing-indicator span:nth-child(1) {
            animation: typing 1s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation: typing 1s infinite 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation: typing 1s infinite 0.4s;
        }
        
        @keyframes typing {
            0% { opacity: 0.4; }
            50% { opacity: 1; }
            100% { opacity: 0.4; }
        }
    `;

    // Add the new styles to the document
    const styleElement = document.createElement('style');
    styleElement.textContent = enhancedStyles;
    document.head.appendChild(styleElement);

    /* ==================== EVENT LISTENERS ==================== */

    // Close modal
    closeModal.addEventListener('click', () => {
        imageModal.classList.remove('show');
    });

    // Close modal when clicking outside image
    imageModal.addEventListener('click', (e) => {
        if (e.target === imageModal) {
            imageModal.classList.remove('show');
        }
    });

    // Back button functionality
    backButton.addEventListener('click', () => {
        gigsContainer.classList.add('d-none');
        subcategoryContainer.classList.remove('d-none');
        backButton.classList.remove('show');
    });

    // Chat bot toggle
    chatbotToggle.addEventListener('click', openChatBot);
    chatbotCloseBtn.addEventListener('click', closeChatBot);

    // Send message on button click
    chatbotSend.addEventListener('click', handleUserInput);

    // Send message on Enter key
    chatbotInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleUserInput();
        }
    });

    /* ==================== INITIALIZE THE APP ==================== */
    document.addEventListener("DOMContentLoaded", () => {
        fetchCategories();
        fetchUserAppointments();
        initializeWebSocket();
        initChatBot();

        // Add scroll effect to navbar
        window.addEventListener('scroll', () => {
            const navbar = document.getElementById('category-nav');
            if (window.scrollY > 20) {
                navbar.style.boxShadow = '0 5px 20px rgba(0, 0, 0, 0.15)';
                navbar.style.background = 'rgba(193, 116, 157, 0.98)';
            } else {
                navbar.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.1)';
                navbar.style.background = 'rgba(193, 116, 157, 0.98)';
            }
        });
    });
</script>
</body>
</html>